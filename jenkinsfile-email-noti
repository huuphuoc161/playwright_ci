// Jenkinsfile-multi-suite
// Runs all available test suites sequentially with comprehensive reporting
// Use this for complete test execution across all test files

pipeline {
    agent any
    
    parameters {
        choice(
            name: 'EXECUTION_MODE',
            choices: ['sequential', 'parallel'],
            description: 'Run tests sequentially or in parallel'
        )
        choice(
            name: 'BROWSER',
            choices: ['chromium', 'firefox', 'webkit'],
            description: 'Select browser for testing'
        )
        choice(
            name: 'HEADLESS_MODE',
            choices: ['headless'],
            description: 'Run tests in headless mode (no UI) or headed mode (with UI)'
        )
    }
    
    environment {
        PYTHON_CMD = 'C:\\Users\\huuphuoc.nguyen\\AppData\\Local\\Python\\bin\\python3.exe'
        PLAYWRIGHT_BROWSERS_PATH = "${WORKSPACE}/ms-playwright/"
        REPORTS_DIR = 'reports'
        JUNIT_REPORT_FILE = "${REPORTS_DIR}/junit.xml"
        HTML_REPORT_FILE = "${REPORTS_DIR}/report.html"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "üîÑ Checking out code..."
                checkout scm
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo "‚öôÔ∏è  Setting up Python environment..."
                bat '''
                    %PYTHON_CMD% --version
                    %PYTHON_CMD% -m venv venv
                    call venv\\Scripts\\activate.bat
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }
        
        stage('Install Playwright') {
            steps {
                echo "üé≠ Installing Playwright browsers..."
                bat '''
                    call venv\\Scripts\\activate.bat
                    playwright install chromium firefox webkit
                '''
            }
        }
        
        stage('Execute Tests') {
            steps {
                script {
                    echo "üöÄ Execution Mode: ${params.EXECUTION_MODE}"
                    echo "üåê Browser: ${params.BROWSER}"
                    echo "üì∫ Headless Mode: ${params.HEADLESS_MODE}"
                    
                    if (params.EXECUTION_MODE == 'parallel') {
                        echo "Running tests in PARALLEL mode..."
                        parallel(
                            'Login Tests': {
                                runTests('tests\\login_suite.py', 'login')
                            },
                            'Election Tests': {
                                if (fileExists('tests/election_page.py')) {
                                    runTests('tests\\election_page.py', 'election')
                                }
                            },
                            'Inventory Tests': {
                                if (fileExists('tests/inventory_page.py')) {
                                    runTests('tests\\inventory_page.py', 'inventory')
                                }
                            }
                        )
                    } else {
                        echo "Running tests in SEQUENTIAL mode..."
                        runTests('tests\\login_suite.py', 'login')
                        if (fileExists('tests/election_page.py')) {
                            runTests('tests\\election_page.py', 'election')
                        }
                        if (fileExists('tests/inventory_page.py')) {
                            runTests('tests\\inventory_page.py', 'inventory')
                        }
                    }
                }
            }
        }

        stage('Publish Test Reports') {
            steps {
                script {
                    echo 'Publishing test reports...'

                    junit "${JUNIT_REPORT_FILE}"

                    publishHTML (target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: "${REPORTS_DIR}",
                        reportFiles: "${HTML_REPORT_FILE.split('/')[-1]}",
                        reportName: 'Playwright HTML Report',
                        reportTitles: ''
                    ])

                    archiveArtifacts artifacts: "${REPORTS_DIR}/*", fingerprinter: true
                }
            }
        }
    }
    
    post {
        always {
            echo "üìä Publishing comprehensive test results..."
        }

        success {
            script {
                echo "‚úÖ Job Succeeded. Sending success email..."
                emailext (
                    to: 'testnotification012026@yopmail.com', // ƒê·ªãa ch·ªâ email nh·∫≠n khi th√†nh c√¥ng
                    subject: "[Jenkins]: ${JOB_NAME} - Build #${BUILD_NUMBER}",
                    body: """
                        <p>Job <b>${JOB_NAME}</b> (Build #${BUILD_NUMBER}) th√†nh c√¥ng!</p>
                        <p>Chi ti·∫øt: <a href="${BUILD_URL}">${BUILD_URL}</a></p>
                        <p>B√°o c√°o HTML: <a href="${BUILD_URL}${HTML_REPORT_URL_NAME}/">Xem b√°o c√°o chi ti·∫øt</a></p>
                        <p>K·∫øt qu·∫£ Test (JUnit): <a href="${BUILD_URL}testReport/">Xem t·ªïng quan test</a></p>
                    """,
                    mimeType: 'text/html',
                    attachmentsPattern: "${REPORTS_DIR}/${HTML_REPORT_FILE}" // ƒê√≠nh k√®m  HTML
                )
            }
        }
        
        failure {
            script {
                echo "‚ùå Job Failed. Sending failure email..."
                emailext (
                    to: 'testnotification012026@yopmail.com', // ƒê·ªãa ch·ªâ email nh·∫≠n khi th·∫•t b·∫°i
                    subject: "[Jenkins]: ${JOB_NAME} - Build #${BUILD_NUMBER}",
                    body: """
                        <p>Job <b>${JOB_NAME}</b> (Build #${BUILD_NUMBER}) <b>TH·∫§T B·∫†I</b>!</p>
                        <p>Vui l√≤ng ki·ªÉm tra g·∫•p.</p>
                        <p>Chi ti·∫øt build: <a href="${BUILD_URL}">${BUILD_URL}</a></p>
                        <p>Console Output: <a href="${BUILD_URL}console">Xem log l·ªói</a></p>
                        <p>B√°o c√°o HTML (n·∫øu c√≥): <a href="${BUILD_URL}${HTML_REPORT_URL_NAME}/">Xem b√°o c√°o</a></p>
                    """,
                    mimeType: 'text/html',
                    attachmentsPattern: "${REPORTS_DIR}/${HTML_REPORT_FILE}"
                )
            }
        }

        unstable {
            script {
                echo "‚ö†Ô∏è Job Unstable. Sending unstable email..."
                emailext (
                    to: 'testnotification012026@yopmail.com', // ƒê·ªãa ch·ªâ email nh·∫≠n khi kh√¥ng ·ªïn ƒë·ªãnh
                    subject: "[Jenkins] KH√îNG ·ªîN ƒê·ªäNH: ${JOB_NAME} - Build #${BUILD_NUMBER}",
                    body: """
                        <p>Job <b>${JOB_NAME}</b> (Build #${BUILD_NUMBER}) kh√¥ng ·ªïn ƒë·ªãnh!</p>
                        <p>Vui l√≤ng xem x√©t c√°c l·ªói test.</p>
                        <p>Chi ti·∫øt build: <a href="${BUILD_URL}">${BUILD_URL}</a></p>
                        <p>B√°o c√°o HTML: <a href="${BUILD_URL}${HTML_REPORT_URL_NAME}/">Xem b√°o c√°o chi ti·∫øt</a></p>
                    """,
                    mimeType: 'text/html',
                    attachmentsPattern: "${REPORTS_DIR}/${HTML_REPORT_FILE}"
                )
            }
        }
    }
}

def runTests(testFile, testName) {
    echo "üß™ Running ${testName} tests with ${params.BROWSER} browser (${params.HEADLESS_MODE} mode)..."
    
    def isHeadless = params.HEADLESS_MODE == 'headless' ? 'true' : 'false'
    
    bat """
        call venv\\Scripts\\activate.bat
        if not exist "%REPORTS_DIR%" mkdir "%REPORTS_DIR%"
        
        set PLAYWRIGHT_HEADLESS=${isHeadless}
        
        pytest ${testFile} -v ^
            --junit-xml="%REPORTS_DIR%\\${testName}_results.xml" ^
            --html="%REPORTS_DIR%\\${testName}_report.html" ^
            --self-contained-html ^
            --alluredir="%REPORTS_DIR%\\allure-results"
    """
}