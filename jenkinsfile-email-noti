// Jenkinsfile-multi-suite
// Runs all available test suites sequentially with comprehensive reporting
// Use this for complete test execution across all test files

pipeline {
    agent any
    
    parameters {
        choice(
            name: 'EXECUTION_MODE',
            choices: ['sequential', 'parallel'],
            description: 'Run tests sequentially or in parallel'
        )
        choice(
            name: 'BROWSER',
            choices: ['chromium', 'firefox', 'webkit'],
            description: 'Select browser for testing'
        )
        choice(
            name: 'HEADLESS_MODE',
            choices: ['headless'],
            description: 'Run tests in headless mode (no UI) or headed mode (with UI)'
        )
    }
    
    environment {
        PYTHON_CMD = 'C:\\Users\\huuphuoc.nguyen\\AppData\\Local\\Python\\bin\\python3.exe'
        PLAYWRIGHT_BROWSERS_PATH = "${WORKSPACE}/ms-playwright/"
        REPORTS_DIR = 'reports'
        JUNIT_REPORT_FILE = "${REPORTS_DIR}/junit.xml"
        HTML_REPORT_FILE = "${REPORTS_DIR}/report.html"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "üîÑ Checking out code..."
                checkout scm
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo "‚öôÔ∏è  Setting up Python environment..."
                bat '''
                    %PYTHON_CMD% --version
                    %PYTHON_CMD% -m venv venv
                    call venv\\Scripts\\activate.bat
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }
        
        stage('Install Playwright') {
            steps {
                echo "üé≠ Installing Playwright browsers..."
                bat '''
                    call venv\\Scripts\\activate.bat
                    playwright install chromium firefox webkit
                '''
            }
        }
        
        stage('Run Tests') {
            steps {
                echo "üß™ Running login tests..."
                bat """
                    call venv\\Scripts\\activate.bat
                    
                    if not exist "${REPORTS_DIR}" mkdir "${REPORTS_DIR}"
                    
                    pytest tests\\login_suite.py -v ^
                        --html="${HTML_REPORT_FILE}" --self-contained-html ^
                        --junit-xml="${JUNIT_REPORT_FILE}"
                    deactivate
                """
            }
        }

        stage('Publish Test Reports') {
            steps {
                script {
                    echo 'Publishing test reports...'

                    junit "${JUNIT_REPORT_FILE}"

                    publishHTML (target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: "${REPORTS_DIR}",
                        reportFiles: "${HTML_REPORT_FILE.split('/')[-1]}",
                        reportName: 'Playwright HTML Report',
                        reportTitles: ''
                    ])

                    archiveArtifacts artifacts: "${REPORTS_DIR}/*", fingerprinter: true
                }
            }
        }
    }
    
    post {
        always {
            echo "üìä Publishing comprehensive test results..."
        }

        success {
            script {
                echo "‚úÖ Job Succeeded. Sending success email..."
                emailext (
                    to: 'nguyenhuuphuoc1806@gmail.com',
                    subject: "[Jenkins]: ${JOB_NAME} - Build #${BUILD_NUMBER} - SUCCESS",
                    body: """
                        <p>Job <b>${JOB_NAME}</b> (Build #${BUILD_NUMBER}) <b>TH√ÄNH C√îNG</b>!</p>
                        <p>Chi ti·∫øt build: <a href="${BUILD_URL}">${BUILD_URL}</a></p>
                        <p>Console Output: <a href="${BUILD_URL}console">Xem log chi ti·∫øt</a></p>"
                        """
                )
            }
        }
        
        failure {
            script {
                echo "‚ùå Job Failed. Sending failure email..."
                emailext (
                    to: 'nguyenhuuphuoc1806@gmail.com',
                    subject: "[Jenkins]: ${JOB_NAME} - Build #${BUILD_NUMBER} - FAILED",
                    body: """
                        <p>Job <b>${JOB_NAME}</b> (Build #${BUILD_NUMBER}) <b>TH·∫§T B·∫†I</b>!</p>
                        <p>Vui l√≤ng ki·ªÉm tra g·∫•p.</p>
                        <p>Chi ti·∫øt build: <a href="${BUILD_URL}">${BUILD_URL}</a></p>
                        <p>Console Output: <a href="${BUILD_URL}console">Xem log l·ªói</a></p>
                    """
                )
            }
        }

        unstable {
            script {
                echo "‚ö†Ô∏è Job Unstable. Sending unstable email..."
                emailext (
                    to: 'nguyenhuuphuoc1806@gmail.com',
                    subject: "[Jenkins]: ${JOB_NAME} - Build #${BUILD_NUMBER} - Usnstable",
                    body: """
                        <p>Job <b>${JOB_NAME}</b> (Build #${BUILD_NUMBER}) <b>KH√îNG ·ªîN ƒê·ªäNH</b>!</p>
                        <p>Vui l√≤ng ki·ªÉm tra g·∫•p.</p>
                        <p>Chi ti·∫øt build: <a href="${BUILD_URL}">${BUILD_URL}</a></p>
                    """
                )
            }
        }
    }
}

def runTests(testFile, testName) {
    echo "üß™ Running ${testName} tests with ${params.BROWSER} browser (${params.HEADLESS_MODE} mode)..."
    
    def isHeadless = params.HEADLESS_MODE == 'headless' ? 'true' : 'false'
    
    bat """
        call venv\\Scripts\\activate.bat
        if not exist "%REPORTS_DIR%" mkdir "%REPORTS_DIR%"
        
        set PLAYWRIGHT_HEADLESS=${isHeadless}
    """
}