// Jenkinsfile-debug
// Verbose mode with detailed logging for debugging issues
// Use this when you need to troubleshoot pipeline problems

pipeline {
    agent any
    
    environment {
        PYTHON_CMD = 'C:\\Users\\huuphuoc.nguyen\\AppData\\Local\\Python\\bin\\python3.exe'
        WORKSPACE_DIR = "${WORKSPACE}"
        REPORTS_DIR = "${WORKSPACE}\\reports"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "ðŸ”„ Checking out code..."
                echo "Workspace: ${WORKSPACE}"
                checkout scm
                
                script {
                    echo "=== Directory Contents ==="
                    bat 'dir "%WORKSPACE%"'
                    echo "=== Git Info ==="
                    bat 'cd /d "%WORKSPACE%" && git status'
                }
            }
        }
        
        stage('System Information') {
            steps {
                echo "ðŸ’» Gathering system information..."
                bat '''
                    @echo off
                    echo === System Info ===
                    systeminfo | findstr /C:"OS Name" /C:"System Boot Time"
                    
                    echo === Python Info ===
                    %PYTHON_CMD% --version
                    %PYTHON_CMD% -c "import sys; print('Python Path:', sys.executable)"
                    
                    echo === Disk Space ===
                    wmic logicaldisk get name, freespace
                    
                    echo === PATH ===
                    echo %PATH%
                '''
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo "âš™ï¸  Setting up Python environment (VERBOSE)..."
                bat '''
                    @echo off
                    echo === Creating Virtual Environment ===
                    cd /d "%WORKSPACE%"
                    echo Current Directory: %CD%
                    
                    echo.
                    echo Step 1: Check Python
                    %PYTHON_CMD% --version
                    
                    echo.
                    echo Step 2: Create venv
                    %PYTHON_CMD% -m venv venv
                    
                    echo.
                    echo Step 3: Activate venv
                    call venv\\Scripts\\activate.bat
                    
                    echo.
                    echo Step 4: Check pip
                    python -m pip --version
                    
                    echo.
                    echo Step 5: Upgrade pip
                    python -m pip install --upgrade pip
                    
                    echo.
                    echo Step 6: Install requirements
                    echo Installing from: %WORKSPACE%\requirements.txt
                    type %WORKSPACE%\requirements.txt
                    echo.
                    pip install -r requirements.txt
                    
                    echo.
                    echo Step 7: Verify installation
                    pip list
                '''
            }
        }
        
        stage('Install Playwright') {
            steps {
                echo "ðŸŽ­ Installing Playwright (VERBOSE)..."
                bat '''
                    @echo off
                    echo === Playwright Installation ===
                    call venv\\Scripts\\activate.bat
                    
                    echo.
                    echo Checking Playwright:
                    playwright --version
                    
                    echo.
                    echo Installing Chromium:
                    playwright install chromium --with-deps
                    
                    echo.
                    echo Verifying installation:
                    dir "%APPDATA%\\.playwright" 2>nul || echo Playwright cache location
                '''
            }
        }
        
        stage('Run Tests (VERBOSE)') {
            steps {
                echo "ðŸ§ª Running tests (VERBOSE MODE)..."
                bat '''
                    @echo off
                    call venv\\Scripts\\activate.bat
                    
                    if not exist "%REPORTS_DIR%" mkdir "%REPORTS_DIR%"
                    
                    echo === Test Collection ===
                    pytest tests\\login_suite.py --collect-only
                    
                    echo.
                    echo === Test Execution ===
                    pytest tests\\login_suite.py -vv -s --tb=long ^
                        --junit-xml="%REPORTS_DIR%\\junit.xml"
                    
                    echo.
                    echo === Test Results ===
                    type "%REPORTS_DIR%\\junit.xml"
                '''
            }
        }
    }
    
    post {
        always {
            echo "ðŸ“Š Publishing results..."
            script {
                echo "=== Workspace Contents After Build ==="
                bat 'dir /s "%WORKSPACE%\\reports" 2>nul || echo No reports generated'
            }
            
            junit testResults: "${REPORTS_DIR}\\junit.xml", allowEmptyResults: true
            archiveArtifacts artifacts: "${REPORTS_DIR}/**/*", allowEmptyArchive: true
        }
        
        success {
            echo "âœ… Debug build passed!"
        }
        
        failure {
            echo "âŒ Debug build failed - check verbose output above"
            script {
                bat '''
                    @echo off
                    echo === DEBUGGING INFO ===
                    echo Current directory: %CD%
                    echo.
                    echo Virtual environment status:
                    if exist venv\\Scripts\\activate.bat (
                        echo venv exists
                    ) else (
                        echo venv NOT FOUND
                    )
                    echo.
                    echo Python in venv:
                    dir venv\\Scripts\\python.exe 2>nul || echo python.exe NOT FOUND
                '''
            }
        }
    }
}
