// Jenkinsfile-basic
// Simple version - Just runs tests without extensive reporting
// Use this to quickly test if pipeline works

pipeline {
    agent any
    
    environment {
        PYTHON_CMD = 'C:\\Users\\huuphuoc.nguyen\\AppData\\Local\\Python\\bin\\python3.exe'
        PLAYWRIGHT_BROWSERS_PATH = "C:\\Users\\huuphuoc.nguyen\\AppData\\Local\\ms-playwright"
        WORKSPACE_DIR = "${WORKSPACE}"
        REPORTS_DIR = "${WORKSPACE}\\reports"
        JUNIT_REPORT_FILE = "${WORKSPACE}\\reports\\junit.xml"
        HTML_REPORT_FILE = "${WORKSPACE}\\reports\\report.html"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "üîÑ Checking out code..."
                checkout scm
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo "‚öôÔ∏è  Setting up Python environment..."
                bat '''
                    %PYTHON_CMD% --version
                    %PYTHON_CMD% -m venv venv
                    call venv\\Scripts\\activate.bat
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }
        
        stage('Install Playwright') {
            steps {
                echo "üé≠ Installing Playwright browsers..."
                bat '''
                    call venv\\Scripts\\activate.bat
                    playwright install
                '''
            }
        }
        
        stage('Run Tests') {
            steps {
                echo "üß™ Running login tests..."
                bat '''
                    call venv\\Scripts\\activate.bat
                    if not exist "%REPORTS_DIR%" mkdir "%REPORTS_DIR%"
                    
                    pytest tests\\login_suite.py -v ^
                        --html="%REPORTS_DIR%\\report.html" --self-contained-html ^
                        --junit-xml="%REPORTS_DIR%\\junit.xml"
                '''
            }
        }
    }
    
    post {
        always {
            echo "üìä Publishing test results..."
            junit testResults: "${REPORTS_DIR}\\junit.xml", allowEmptyResults: true
            
            script {
                echo 'Publishing HTML test report...'
                publishHTML (target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: "${REPORTS_DIR}",
                    reportFiles: "report.html",
                    reportName: 'Playwright HTML Report',
                    reportTitles: ''
                ])
            }
            
            archiveArtifacts artifacts: "${REPORTS_DIR}/**/*", allowEmptyArchive: true
        }
        
        success {
            echo "‚úÖ Tests passed!"
        }
        
        failure {
            echo "‚ùå Tests failed!"
        }
    }
}
