pipeline {
    agent any

    // Environment block for variables that Jenkins itself needs or are derived
    environment {
        // These will be populated from 'config' later, or are fixed paths
        PYTHON_EXE = "" // Will be set from config.python_executable_path
        PLAYWRIGHT_BROWSERS_PATH = "" // Will be set from config.playwright_browsers_path_relative + WORKSPACE
        REPORTS_DIR = "" // Will be set from config.reports_directory
        JUNIT_REPORT_FILE = "" // Will be set from config.reports_directory + config.junit_report_filename
        HTML_REPORT_FILE = "" // Will be set from config.reports_directory + config.html_report_filename
        TEST_SUITE = "" // Will be set from config.test_suite_file
    }

    stages {
        stage('Checkout') {
            steps {
                echo "üîÑ Checking out code..."
                // Use git config from YAML or keep it fixed if it rarely changes
                // For now, keeping it fixed as it's common for the repo to define the pipeline
                git branch: 'main', url: 'https://github.com/huuphuoc161/playwright_ci.git/'
            }
        }

        stage('Load Configuration') {
            steps {
                script {
                    echo "üìù Loading pipeline configuration from yaml file..."
                    
                    // Since readYaml requires Pipeline Utility Steps Plugin,
                    // we'll use a simpler approach with readFile and basic parsing
                    // OR use environment variables from Jenkins UI configuration
                    
                    // Option 1: Read and parse YAML file manually
                    try {
                        def yamlContent = readFile(file: '.github/workflows/jenkinsPipeline.yaml')
                        echo "YAML file loaded successfully"
                        
                        // Set default values if not found in YAML
                        env.PYTHON_EXE = env.PYTHON_EXE ?: 'C:\\\\Users\\\\huuphuoc.nguyen\\\\AppData\\\\Local\\\\Python\\\\bin\\\\python3.exe'
                        env.PLAYWRIGHT_BROWSERS_PATH = env.PLAYWRIGHT_BROWSERS_PATH ?: "C:\\Users\\huuphuoc.nguyen\\AppData\\Local\\ms-playwright"
                        env.REPORTS_DIR = env.REPORTS_DIR ?: 'reports'
                        env.JUNIT_REPORT_FILE = env.JUNIT_REPORT_FILE ?: "${REPORTS_DIR}/junit.xml"
                        env.HTML_REPORT_FILE = env.HTML_REPORT_FILE ?: "${REPORTS_DIR}/report.html"
                        env.TEST_SUITE = env.TEST_SUITE ?: 'tests/login_suite.py'
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Could not read YAML file, using default values: ${e.message}"
                        
                        // Use default values
                        env.PYTHON_EXE = 'C:\\\\Users\\\\huuphuoc.nguyen\\\\AppData\\\\Local\\\\Python\\\\bin\\\\python3.exe'
                        env.PLAYWRIGHT_BROWSERS_PATH = "C:\\Users\\huuphuoc.nguyen\\AppData\\Local\\ms-playwright"
                        env.REPORTS_DIR = 'reports'
                        env.JUNIT_REPORT_FILE = "${REPORTS_DIR}/junit.xml"
                        env.HTML_REPORT_FILE = "${REPORTS_DIR}/report.html"
                        env.TEST_SUITE = 'tests/login_suite.py'
                    }

                    echo "Configuration loaded:"
                    echo "  Python Executable: ${env.PYTHON_EXE}"
                    echo "  Playwright Browsers Path: ${env.PLAYWRIGHT_BROWSERS_PATH}"
                    echo "  Reports Directory: ${env.REPORTS_DIR}"
                    echo "  JUnit Report File: ${env.JUNIT_REPORT_FILE}"
                    echo "  HTML Report File: ${env.HTML_REPORT_FILE}"
                    echo "  Test Suite: ${env.TEST_SUITE}"
                }
            }
        }

        stage('Setup Environment') {
            steps {
                echo "‚öôÔ∏è  Setting up Python environment..."
                bat """
                    echo "Using Python from: ${PYTHON_EXE}"
                    "${PYTHON_EXE}" --version
                    "${PYTHON_EXE}" -m venv venv
                    call venv\\Scripts\\activate.bat
                    pip install --upgrade pip
                    pip install -r requirements.txt
                    deactivate
                """
            }
        }

        stage('Install Playwright') {
            steps {
                echo "üé≠ Installing Playwright browsers..."
                bat """
                    call venv\\Scripts\\activate.bat
                    playwright install
                    deactivate
                """
            }
        }

        stage('Run Tests') {
            steps {
                echo "üß™ Running tests from ${TEST_SUITE}..."
                bat """
                    call venv\\Scripts\\activate.bat
                    
                    if not exist "${REPORTS_DIR}" mkdir "${REPORTS_DIR}"
                    
                    pytest "${TEST_SUITE}" -v ^
                        --html="${HTML_REPORT_FILE}" --self-contained-html ^
                        --junit-xml="${JUNIT_REPORT_FILE}"
                    deactivate
                """
            }
        }

        stage('Publish Test Reports') {
            steps {
                script {
                    echo 'Publishing test reports...'

                    junit "${JUNIT_REPORT_FILE}"

                    publishHTML (target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: "${REPORTS_DIR}",
                        reportFiles: "${HTML_REPORT_FILE.split('/')[-1]}",
                        reportName: 'Playwright HTML Report',
                        reportTitles: ''
                    ])

                    archiveArtifacts artifacts: "${REPORTS_DIR}/*", fingerprinter: true
                }
            }
        }
    }

    post {
        always {
            echo "üìä Publishing test results..."
        }

        success {
            echo "‚úÖ Tests passed!"
        }

        failure {
            echo "‚ùå Tests failed!"
        }
    }
}