// Jenkinsfile-multi-suite
// Runs all available test suites sequentially with comprehensive reporting
// Use this for complete test execution across all test files

pipeline {
    agent any
    
    parameters {
        choice(
            name: 'EXECUTION_MODE',
            choices: ['sequential', 'parallel'],
            description: 'Run tests sequentially or in parallel'
        )
        choice(
            name: 'BROWSER',
            choices: ['chromium', 'firefox', 'webkit'],
            description: 'Select browser for testing'
        )
        choice(
            name: 'HEADLESS_MODE',
            choices: ['headless'],
            description: 'Run tests in headless mode (no UI) or headed mode (with UI)'
        )
    }
    
    environment {
        PYTHON_CMD = 'C:\\Users\\huuphuoc.nguyen\\AppData\\Local\\Python\\bin\\python3.exe'
        PLAYWRIGHT_BROWSERS_PATH = "C:\\Users\\huuphuoc.nguyen\\AppData\\Local\\ms-playwright"
        REPORTS_DIR = 'reports'
        JUNIT_REPORT_FILE = "${REPORTS_DIR}/junit.xml"
        HTML_REPORT_FILE = "${REPORTS_DIR}/report.html"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "üîÑ Checking out code..."
                checkout scm
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo "‚öôÔ∏è  Setting up Python environment..."
                bat '''
                    %PYTHON_CMD% --version
                    %PYTHON_CMD% -m venv venv
                    call venv\\Scripts\\activate.bat
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }
        
        stage('Install Playwright') {
            steps {
                echo "üé≠ Installing Playwright browsers..."
                bat '''
                    call venv\\Scripts\\activate.bat
                    playwright install
                '''
            }
        }
        
        stage('Execute Tests') {
            steps {
                echo "üß™ Running login tests..."
                bat """
                    call venv\\Scripts\\activate.bat
                    
                    if not exist "${REPORTS_DIR}" mkdir "${REPORTS_DIR}"
                    
                    pytest tests\\login_suite.py -v ^
                        --html="${HTML_REPORT_FILE}" --self-contained-html ^
                        --junit-xml="${JUNIT_REPORT_FILE}"
                    deactivate
                """
            }
        }
    }
    
    post {
        always {
            echo "üìä Publishing comprehensive test results..."
            junit testResults: "${REPORTS_DIR}\\*_results.xml", allowEmptyResults: true
            
            script {
                echo 'Publishing HTML test reports...'
                
                // Publish Login Report
                publishHTML (target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: "${REPORTS_DIR}",
                    reportFiles: 'login_report.html',
                    reportName: 'Login Tests Report'
                ])
            }
            
            archiveArtifacts artifacts: "${REPORTS_DIR}/**/*", allowEmptyArchive: true
        }
        
        success {
            script {
                echo "‚úÖ Job Succeeded. Sending success notification to Slack..."
                slackSend (
                    channel: '#demo-webhook', // K√™nh Slack nh·∫≠n th√¥ng b√°o th√†nh c√¥ng
                    color: 'good',          
                    message: "‚úÖ *Job ${JOB_NAME}* (Build #${BUILD_NUMBER}) ƒë√£ ch·∫°y th√†nh c√¥ng! " +
                             "Xem chi ti·∫øt: <${BUILD_URL}|Link Build>" // Link ƒë·∫øn Jenkins build
                )
            }
        }
        
        failure {
            script {
                echo "‚ùå Job Failed. Sending failure notification to Slack..."
                slackSend (
                    channel: '#demo-webhook', // K√™nh Slack ƒë·ªÉ g·ª≠i th√¥ng b√°o th·∫•t b·∫°i
                    color: 'danger',         
                    message: "‚ùå *Job ${JOB_NAME}* (Build #${BUILD_NUMBER}) ƒë√£ *TH·∫§T B·∫†I*! " +
                             "Vui l√≤ng ki·ªÉm tra g·∫•p: <${BUILD_URL}|Link Build>"
                )
            }
        }

        unstable {
            script {
                echo "‚ö†Ô∏è Job Unstable. Sending unstable notification to Slack..."
                slackSend (
                    channel: '#demo-webhook', // K√™nh Slack ƒë·ªÉ g·ª≠i th√¥ng b√°o kh√¥ng ·ªïn ƒë·ªãnh
                    color: 'warning',       
                    message: "‚ö†Ô∏è *Job ${JOB_NAME}* (Build #${BUILD_NUMBER}) ƒëang ·ªü tr·∫°ng th√°i *KH√îNG ·ªîN ƒê·ªäNH*. " +
                             "Vui l√≤ng ki·ªÉm tra: <${BUILD_URL}|Link Build>"
                )
            }
        }
    }
}

def runTests(testFile, testName) {
    echo "üß™ Running ${testName} tests with ${params.BROWSER} browser (${params.HEADLESS_MODE} mode)..."
    
    def isHeadless = params.HEADLESS_MODE == 'headless' ? 'true' : 'false'
    
    bat """
        call venv\\Scripts\\activate.bat
        if not exist "%REPORTS_DIR%" mkdir "%REPORTS_DIR%"
        
        set PLAYWRIGHT_HEADLESS=${isHeadless}
    """
}
