// Jenkinsfile-multi-suite
// Runs all available test suites sequentially with comprehensive reporting
// Use this for complete test execution across all test files

pipeline {
    agent any
    
    parameters {
        choice(
            name: 'EXECUTION_MODE',
            choices: ['sequential', 'parallel'],
            description: 'Run tests sequentially or in parallel'
        )
        choice(
            name: 'BROWSER',
            choices: ['chromium', 'firefox', 'webkit'],
            description: 'Select browser for testing'
        )
        choice(
            name: 'HEADLESS_MODE',
            choices: ['headless'],
            description: 'Run tests in headless mode (no UI) or headed mode (with UI)'
        )
    }
    
    environment {
        PYTHON_CMD = 'C:\\Users\\huuphuoc.nguyen\\AppData\\Local\\Python\\bin\\python3.exe'
        WORKSPACE_DIR = "${WORKSPACE}"
        REPORTS_DIR = "${WORKSPACE}\\reports"
        ALLURE_RESULTS = "${WORKSPACE}\\reports\\allure-results"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "üîÑ Checking out code..."
                checkout scm
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo "‚öôÔ∏è  Setting up Python environment..."
                bat '''
                    %PYTHON_CMD% --version
                    %PYTHON_CMD% -m venv venv
                    call venv\\Scripts\\activate.bat
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }
        
        stage('Install Playwright') {
            steps {
                echo "üé≠ Installing Playwright browsers..."
                bat '''
                    call venv\\Scripts\\activate.bat
                    playwright install chromium firefox webkit
                '''
            }
        }
        
        stage('Execute Tests') {
            steps {
                script {
                    echo "üöÄ Execution Mode: ${params.EXECUTION_MODE}"
                    echo "üåê Browser: ${params.BROWSER}"
                    echo "üì∫ Headless Mode: ${params.HEADLESS_MODE}"
                    
                    if (params.EXECUTION_MODE == 'parallel') {
                        echo "Running tests in PARALLEL mode..."
                        parallel(
                            'Login Tests': {
                                runTests('tests\\login_suite.py', 'login')
                            },
                            'Election Tests': {
                                if (fileExists('tests/election_page.py')) {
                                    runTests('tests\\election_page.py', 'election')
                                }
                            },
                            'Inventory Tests': {
                                if (fileExists('tests/inventory_page.py')) {
                                    runTests('tests\\inventory_page.py', 'inventory')
                                }
                            }
                        )
                    } else {
                        echo "Running tests in SEQUENTIAL mode..."
                        runTests('tests\\login_suite.py', 'login')
                        if (fileExists('tests/election_page.py')) {
                            runTests('tests\\election_page.py', 'election')
                        }
                        if (fileExists('tests/inventory_page.py')) {
                            runTests('tests\\inventory_page.py', 'inventory')
                        }
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "üìä Publishing comprehensive test results..."
            junit testResults: "${REPORTS_DIR}\\*_results.xml", allowEmptyResults: true
            
            script {
                echo 'Publishing HTML test reports...'
                
                // Publish Login Report
                publishHTML (target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: "${REPORTS_DIR}",
                    reportFiles: 'login_report.html',
                    reportName: 'Login Tests Report'
                ])
                
                // Publish Election Report if exists
                if (fileExists("${REPORTS_DIR}\\election_report.html")) {
                    publishHTML (target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: "${REPORTS_DIR}",
                        reportFiles: 'election_report.html',
                        reportName: 'Election Tests Report'
                    ])
                }
                
                // Publish Inventory Report if exists
                if (fileExists("${REPORTS_DIR}\\inventory_report.html")) {
                    publishHTML (target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: "${REPORTS_DIR}",
                        reportFiles: 'inventory_report.html',
                        reportName: 'Inventory Tests Report'
                    ])
                }
            }
            
            archiveArtifacts artifacts: "${REPORTS_DIR}/**/*", allowEmptyArchive: true
            
            // Publish Allure report if available
            script {
                if (fileExists("${REPORTS_DIR}\\allure-results")) {
                    echo "üìà Publishing Allure report..."
                    try {
                        allure includeProperties: false,
                               jdk: '',
                               results: [[path: "${REPORTS_DIR}\\allure-results"]]
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è  Allure plugin not available"
                    }
                }
            }
            
            // Update build description
            script {
                currentBuild.description = """
                <h3>üìä Complete Test Suite Results:</h3>
                <ul>
                    <li><a href="Login%20Tests%20Report/">üìÑ Login Tests Report</a></li>
                    <li><a href="allure-report/">üìà Allure Report (Trends)</a></li>
                </ul>
                """
            }
        }
        
        success {
            script {
                echo "‚úÖ Job Succeeded. Sending success notification to Slack..."
                slackSend (
                    channel: '#jenkins-job', // K√™nh Slack nh·∫≠n th√¥ng b√°o th√†nh c√¥ng
                    color: 'good',          
                    message: "‚úÖ *Job ${JOB_NAME}* (Build #${BUILD_NUMBER}) ƒë√£ ch·∫°y th√†nh c√¥ng! " +
                             "Xem chi ti·∫øt: <${BUILD_URL}|Link Build>" // Link ƒë·∫øn Jenkins build
                )
            }
        }
        
        failure {
            script {
                echo "‚ùå Job Failed. Sending failure notification to Slack..."
                slackSend (
                    channel: '#jenkins-job', // K√™nh Slack ƒë·ªÉ g·ª≠i th√¥ng b√°o th·∫•t b·∫°i
                    color: 'danger',         
                    message: "‚ùå *Job ${JOB_NAME}* (Build #${BUILD_NUMBER}) ƒë√£ *TH·∫§T B·∫†I*! " +
                             "Vui l√≤ng ki·ªÉm tra g·∫•p: <${BUILD_URL}|Link Build>"
                )
            }
        }

        unstable {
            script {
                echo "‚ö†Ô∏è Job Unstable. Sending unstable notification to Slack..."
                slackSend (
                    channel: '#jenkins-job', // K√™nh Slack ƒë·ªÉ g·ª≠i th√¥ng b√°o kh√¥ng ·ªïn ƒë·ªãnh
                    color: 'warning',       
                    message: "‚ö†Ô∏è *Job ${JOB_NAME}* (Build #${BUILD_NUMBER}) ƒëang ·ªü tr·∫°ng th√°i *KH√îNG ·ªîN ƒê·ªäNH*. " +
                             "Vui l√≤ng ki·ªÉm tra: <${BUILD_URL}|Link Build>"
                )
            }
        }
    }
}

def runTests(testFile, testName) {
    echo "üß™ Running ${testName} tests with ${params.BROWSER} browser (${params.HEADLESS_MODE} mode)..."
    
    def isHeadless = params.HEADLESS_MODE == 'headless' ? 'true' : 'false'
    
    bat """
        call venv\\Scripts\\activate.bat
        if not exist "%REPORTS_DIR%" mkdir "%REPORTS_DIR%"
        
        set PLAYWRIGHT_HEADLESS=${isHeadless}
        
        pytest ${testFile} -v ^
            --junit-xml="%REPORTS_DIR%\\${testName}_results.xml" ^
            --html="%REPORTS_DIR%\\${testName}_report.html" ^
            --self-contained-html ^
            --alluredir="%REPORTS_DIR%\\allure-results"
    """
}
            --alluredir="%REPORTS_DIR%\\allure-results"
    """
}
            --self-contained-html ^
            --alluredir="%REPORTS_DIR%\\allure-results"
    """
}
